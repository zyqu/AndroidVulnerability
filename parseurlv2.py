#!/usr/bin/python

import os
import json 
class FileParseUrl: 

	def __init__(self,path):
		self.path=path
		self.file_output=open("/home/zyqu/Research/Android_sec/parsexml/VulnerabilityHttpConnection","w")

	def GetUrl(self,path):
		list_dirs = os.walk(path) 
		vulnerapp=[]
		vulnerapp=set(vulnerapp)
		vulnerappnum=0
		for root, dirs, files in list_dirs: 
   
			for f in files:
				httplist=[]
				filepath=os.path.join(root, f)
				if filepath.find(".smali")>=0:# or filepath.find(".properties")>=0:
					

					file_object=open(filepath)

					try:
						list_of_all_the_lines = file_object.readlines()
						for line in list_of_all_the_lines:
							templine=line.lower()
							templine=templine.strip()
							if templine.find("http://")>=0 and templine.find("https://")<0: 
								templine = templine[templine.find("http://") :]		
								#templine=templine[7:]

								if templine.find("\"")>0:
									templine = templine[:templine.find("\"")]
								if templine[len(templine)-1]=="\\":
									templine=templine[:len(templine)-1]
								if templine.find ('schemas.android.com')<0 and len(templine)>7:
									httplist.append(templine)		

					finally:
						if len(httplist)>0:
							packagename=self.GetPackage(filepath,path)
							self.file_output.write(packagename)
							self.file_output.write('  ')
							if packagename not in vulnerapp:
								vulnerappnum=vulnerappnum+1
								vulnerapp.add(packagename)	
							for elem in httplist:
								self.file_output.write(elem)
								self.file_output.write(',')
							self.file_output.write('\n')	
						file_object.close()
		print vulnerappnum	
	
	def GetPackage(self,filepath,rootpath):
		count=0
		temppath=rootpath

		for char in temppath:
			if char=='/':
				count=count+1
				temppath=temppath[temppath.find('/'):]

		icount=0
		if rootpath[len(rootpath)-1:]=='/':		
			while (icount<count):
				filepath=filepath[filepath.find('/')+1:]
				icount=icount+1

			filepath=filepath[:filepath.find('/')]
		if rootpath[len(rootpath)-1:]!='/':		
			while (icount<(count+1)):
				filepath=filepath[filepath.find('/')+1:]
				icount=icount+1

			filepath=filepath[:filepath.find('/')]
		return filepath			

if __name__=="__main__":
	fileparseurl=FileParseUrl("")
	fileparseurl.GetUrl("/home/zyqu/Research/Android_sec/parsexml/depackedapps")


