#!/usr/bin/python

# Written by Zhengyang with modifications from Vaibhav

import os
import json 
from xml.dom.minidom import parse,parseString 
#parse the AndroidManifest.xml so as to get the entry of program
class XmlConfig: 
    def __init__(self):
        pass

    def getAndroidManifestXml(self,path):
        doc=parse(path)

#get the package full name
        manifest = doc.getElementsByTagName("manifest")
	for node in manifest:
            self.package = node.getAttribute("package")

        self.listact = self.elements('activity')
        self.listserv = self.elements('service')
        self.listrece = self.elements('receiver')
        self.listprov = self.elements('provider')
        self.listactalias = self.elements('activity-alias')
        self.listuselibr = self.elements('uses-library')

    def elements(self, tagname):
	doc=parse()
        elemlist = []
        #elems = doc.getElementsByTagName("uses-library")
        elems = doc.getElementsByTagName(tagname)
        for node in elems: 
            name = node.getAttribute("android:name")
            if name.startswith('.'):
                name = self.package + name
            elif '.' not in 'name':
                name = self.package + "." + name
            elemlist.append(name)
        

def getViews(layoutpath, lsty):
    doc=parse(layoutpath)
    views=doc.getElementsByTagName("*")
    for node in views:
        lsty.add(fullViewName(node.nodeName))

def toJvmName(cls):
    return 'L' + cls.replace('.', '/') + ';'

def fullViewName(view):
    if '.' in view:
        return view
    else:
        return 'android.widget.' + view



import sys
if __name__=="__main__":
    xmlf = XmlConfig()
    maindict = {}
    rootDir = sys.argv[1]
    list_dirs = os.walk(rootDir) 
    lsty = set()
    for root, dirs, files in list_dirs: 
        for f in files: 
            filepath=os.path.join(root, f)
	    if filepath.find("AndroidManifest.xml")>0:
		#print filepath
    		xmlf.getAndroidManifestXml(filepath)
	    if filepath.find("/res/layout")>0 and filepath.find(".xml")>0 :
		#print filepath
		getViews(filepath, lsty)
   
    
    maindict["Activity"]=xmlf.listact
    maindict["Service"]=xmlf.listserv
    maindict["Receiver"]=xmlf.listrece
    maindict["Provider"] = xmlf.listprov
    maindict["Activity-alias"] = xmlf.listactalias
    maindict["Uses-library"] = xmlf.listuselibr
    maindict["View"] = lsty

    print json.dumps(maindict)




