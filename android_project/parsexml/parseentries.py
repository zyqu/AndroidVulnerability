#!/usr/bin/python

import os
import json 
from xml.dom.minidom import parse,parseString 
#parse the AndroidManifest.xml so as to get the entry of program
class XmlConfig: 
      def __init__(self,path):
	 self.listact=[]
         self.listserv=[]
         self.listrece=[]
#xmlData contains the androidManifestXml info      
         self.path=path

#get the permissions in the deputy app
	 self.deputypermissions=[]

      def GetAndroidManifestXml(self,path):
         doc=parse(path)

#get the package full name
         manifest= doc.getElementsByTagName("manifest")
	 for node in manifest:
                 package=node.getAttribute("package")


#get the permission in of the deputy
         deputypermission= doc.getElementsByTagName("uses-permission")
	 for node in deputypermission:
                 permissionname=node.getAttribute("android:name")
		 if permissionname!='':
			self.deputypermissions.append(permissionname)

#find all the entries: activity
         activities= doc.getElementsByTagName("activity")
         for node in activities: 
		 tempstr=node.getAttribute("android:name")
		 counter=0
		 for char in tempstr:
			if char=='.':
				counter+=1
		 if counter==1:
			tempstr=package+tempstr  
		 if counter==0:
			tempstr=package+"."+tempstr 
                 permission=node.getAttribute("android:permission")
		 if permission!='':
		 	tempstr=tempstr+ ', ' + permission
		 self.listact.append(tempstr)

   

#find all the entries: service
         services= doc.getElementsByTagName("service")
         for node in services:  
		 tempstr=node.getAttribute("android:name")   
		 counter=0
		 for char in tempstr:
			if char=='.':
				counter+=1
		 if counter==1:
			tempstr=package+tempstr  
		 if counter==0:
			tempstr=package+"."+tempstr                 
                 permission=node.getAttribute("android:permission")
		 if permission!='':
		 	tempstr=tempstr+ ', ' + permission
		 self.listact.append(tempstr)


#find all the entries: receiver
         receivers= doc.getElementsByTagName("receiver")
         for node in receivers: 
		 tempstr=node.getAttribute("android:name")
		 counter=0
		 for char in tempstr:
			if char=='.':
				counter+=1
		 if counter==1:
			tempstr=package+tempstr  
		 if counter==0:
			tempstr=package+"."+tempstr 
                 #b=("receiver",tempstr)
                 permission=node.getAttribute("android:permission")
		 if permission!='':
		 	tempstr=tempstr+ ', ' + permission
		 self.listact.append(tempstr)


if __name__=="__main__":
    xmlf=XmlConfig("")
    dict={}
    #need to change the rootDir in Android
    rootDir="/usr/android/android_project/parsexml"
    list_dirs = os.walk(rootDir) 
    for root, dirs, files in list_dirs:     
        for f in files: 
            filepath=os.path.join(root, f)
	    if filepath.find("AndroidManifest.xml")>0:
		#print filepath
    		xmlf.GetAndroidManifestXml(filepath)
   

    if len(xmlf.deputypermissions)>0:
      encodedjson= json.dumps(xmlf.deputypermissions)
      dict["DeputyPermissions"]=encodedjson


    if len(xmlf.listact)>0:
      encodedjson= json.dumps(xmlf.listact)
      dict["Activity"]=encodedjson

    if len(xmlf.listserv)>0:
      encodedjson= json.dumps(xmlf.listserv)
      dict["Service"]=encodedjson

    if len(xmlf.listrece)>0:
      encodedjson= json.dumps(xmlf.listrece)
      dict["Receiver"]=encodedjson



    print dict



