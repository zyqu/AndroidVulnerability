#!/usr/bin/python

#11/21/2012 Zhengyang 

import os
import json 
from xml.dom.minidom import parse,parseString 
#parse the AndroidManifest.xml so as to get the entry of program
class XmlConfig: 
      def __init__(self,path):    
         self.path=path
#result output
         self.file_output=open("/home/zyqu/Research/Android_sec/parsexml/VulnerabilityConfusedDeputy","w")
         self.count=0

      def GetAndroidManifestXml(self,path):
         doc=parse(path)
 	 deputypermissions=[]

#get the package full name
         manifest= doc.getElementsByTagName("manifest")
	 for node in manifest:
                 package=node.getAttribute("package")



#get the permission in of the deputy
         deputypermission= doc.getElementsByTagName("uses-permission")
	 for node in deputypermission:
                 permissionname=node.getAttribute("android:name")

		 if permissionname!='':
		   deputypermissions.append(permissionname)


#show whether the app has potential vulnerability
	 label2=0
	 label3=0
	 label=0



   

#find all the entries: service
         services= doc.getElementsByTagName("service")
         for node in services:  
                 permission=node.getAttribute("android:permission")
		 if permission=='':
		   label2=1
	 if len(services)==0:
	   label2=0



#find all the entries: receiver
         receivers= doc.getElementsByTagName("receiver")
         for node in receivers: 
                 permission=node.getAttribute("android:permission")
		 if permission=='':
		   label3=1
	 if len(receivers)==0:
	   label3=0
         
         if label2+label3>=1:
	   label=1

	 if len(deputypermissions)==0:
	   label=0

         if label==1:
           self.file_output.write(package)
           self.file_output.write('  ')
	   for elem in deputypermissions:
             self.file_output.write(elem)
             self.file_output.write('  ')
	   self.count=self.count+1
           self.file_output.write('\n')


if __name__=="__main__":
    xmlf=XmlConfig("")
    dict={}
    #need to change the rootDir in Android
    rootDir="/home/zyqu/Research/Android_sec/parsexml/depackedapps/"
    list_dirs = os.walk(rootDir) 
    for root, dirs, files in list_dirs:     
        for f in files: 
            filepath=os.path.join(root, f)
	    if filepath.find("AndroidManifest.xml")>=0:
    		xmlf.GetAndroidManifestXml(filepath)
    print xmlf.count
   



